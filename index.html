<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>T2-C Wartungsprotokoll ‚Äì PRO (M365 Shared)</title>

  <!-- PDF + Charts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Microsoft Auth Library (MSAL) for SPA -->
  <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@3/dist/msal-browser.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background-color: #f8f9fa; }
    h1 { color: #333; margin-bottom: 10px; }
    label { font-weight: bold; display: block; margin-top: 15px; }
    select, input[type="text"], button, textarea { width: 100%; padding: 10px; margin-top: 5px; font-size: 16px; }
    .row { display: flex; gap: 20px; flex-wrap: wrap; }
    .half { flex: 1; min-width: 220px; }
    .log-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    .log-table th, .log-table td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .log-table th { background-color: #eaeaea; }
    .btn { background-color: #4CAF50; color: white; border: none; cursor: pointer; margin-top: 12px; }
    .btn:hover { background-color: #45a049; }
    .btn.secondary { background-color: #0d6efd; }
    .btn.secondary:hover { background-color: #0b5ed7; }
    .btn.danger { background-color: #dc3545; }
    .btn.danger:hover { background-color: #bb2d3b; }
    .dashboard, .chart-box, .auth-box { margin-top: 18px; padding: 14px; background-color: #eef; border-radius: 8px; }
    .dashboard div { margin: 5px 0; font-weight: bold; }
    .search-box { margin-top: 14px; }
    .muted { color:#555; font-size: 13px; }
    .status { margin-top: 8px; padding: 10px; border-radius: 8px; background: #fff; border: 1px solid #ddd; }
    .status.ok { border-color: #198754; }
    .status.warn { border-color: #ffc107; }
    .status.err { border-color: #dc3545; }
    .top-actions { display:flex; gap:10px; flex-wrap: wrap; }
  
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 10px; }
    .kpi { background:#fff; border:1px solid #dde; border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .kpi .label { color:#556; font-size: 13px; margin-bottom: 6px; }
    .kpi .value { font-size: 22px; font-weight: 800; color:#223; }
    .kpi .sub { color:#667; font-size: 12px; margin-top: 4px; }
    .dash-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 14px; margin-top: 14px; }
    .chart-card { background:#fff; border:1px solid #dde; border-radius: 12px; padding: 12px; }
    .chart-card h3 { margin: 6px 0 10px; font-size: 16px; color:#223; }
    .chart-card canvas { width: 100% !important; height: 280px !important; }


    /* Collapsible dashboard */
    details.dash-details { margin-top: 18px; }
    details.dash-details > summary {
      cursor: pointer;
      list-style: none;
      padding: 12px 14px;
      background: #eef;
      border-radius: 8px;
      font-weight: bold;
      user-select: none;
    }
    details.dash-details[open] > summary { margin-bottom: 10px; }
    details.dash-details > summary::-webkit-details-marker { display:none; }
    details.dash-details > summary::before { content: "‚ñ∏ "; }
    details.dash-details[open] > summary::before { content: "‚ñæ "; }

    .matrix-card { margin-top: 14px; padding: 12px; background: #fff; border-radius: 10px; border: 1px solid #ddd; }
    .matrix-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    .matrix-table th, .matrix-table td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .matrix-table th { background-color: #f2f2f2; position: sticky; top: 0; }
    .matrix-table td.left { text-align: left; font-weight: bold; }

  </style>
</head>
<body>

<h1>üßæ T2-C Wartungsprotokoll ‚Äì PRO (gemeinsame Daten via M365)</h1>
<div class="muted">
  Diese Version speichert & l√§dt alle Eintr√§ge gemeinsam aus einem JSON-Log in eurem freigegebenen OneDrive/SharePoint-Ordner.
</div>

<div class="auth-box">
  <div class="top-actions">
    <button class="btn secondary" onclick="signIn()">üîê Anmelden</button>
    <button class="btn danger" onclick="signOut()">üö™ Abmelden</button>
    <button class="btn" onclick="loadFromCloud()">‚ü≥ Aus Cloud laden</button>
  </div>
  <div id="authStatus" class="status warn">Nicht angemeldet.</div>
  <div class="muted">
    Speicherort: <span id="cloudLocation">(wird nach Anmeldung aufgel√∂st)</span><br/>
    Datei: <b>t2c-wartung-log.json</b>
  </div>
</div>


<details class="dash-details" id="dashDetails" open>
  <summary>üìä Dashboard anzeigen/ausblenden</summary>
  <div class="dashboard" id="advancedDashboard">
  <div><strong>üìä Dashboard (aus allen Cloud-Eintr√§gen):</strong></div>

  <div class="kpi-grid">
    <div class="kpi">
      <div class="label">Gesamt-Eintr√§ge</div>
      <div class="value" id="kpi-total">0</div>
      <div class="sub" id="kpi-last">Letzter Eintrag: ‚Äì</div>
    </div>
    <div class="kpi">
      <div class="label">Druckkopf gewechselt</div>
      <div class="value" id="kpi-printhead">0</div>
      <div class="sub">Summe √ºber alle Ger√§te</div>
    </div>
    <div class="kpi">
      <div class="label">Wiper gewechselt</div>
      <div class="value" id="kpi-wiper">0</div>
      <div class="sub">Summe √ºber alle Ger√§te</div>
    </div>
    <div class="kpi">
      <div class="label">Farbwechsel</div>
      <div class="value" id="kpi-colorchange">0</div>
      <div class="sub">Summe √ºber alle Ger√§te</div>
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <div class="half">
      <label for="dashPrinterFilter">Dashboard-Filter: Drucker</label>
      <select id="dashPrinterFilter" onchange="updateColorPerPrinterChart()">
        <option value="__ALL__">Alle Drucker</option>
      </select>
      <div class="muted">Diese Auswahl beeinflusst die Grafik ‚ÄûFarben pro Drucker‚Äú.</div>
    </div>
  </div>

  <div class="dash-grid">
    <div class="chart-card">
      <h3>Wartungen pro Ger√§t</h3>
      <canvas id="printerChart"></canvas>
    </div>
    <div class="chart-card">
      <h3>Wartungen nach Art</h3>
      <canvas id="actionChart"></canvas>
    </div>
    <div class="chart-card">
      <h3>Wartungen pro Monat</h3>
      <canvas id="monthlyChart"></canvas>
    </div>
  </div>

  
  <div class="matrix-card">
    <h3>üß© Verschlei√ü-Matrix (Ger√§t √ó Wartungsart)</h3>
    <div class="muted">Z√§hlt, wie oft welche Wartung an welchem Drucker durchgef√ºhrt wurde.</div>
    <div style="overflow:auto; max-height: 360px;">
      <table class="matrix-table" id="wearMatrix"></table>
    </div>
<div class="matrix-box">
      <div class="muted">üìè Verschlei√ü pro 100.000 Etiketten (nur wenn eine Zahl vorhanden ist):</div>
      <table class="matrix-table" id="wearPer100k"></table>
      <div class="muted" style="margin-top:6px;">Hinweis: Die Zahl wird aus ‚ÄûEtikettenz√§hler‚Äú (oder ersatzweise aus ‚ÄûLeistung‚Äú, falls dort eine Zahl steht) gelesen.</div>
    </div>

  </div>

<div style="margin-top:14px; font-weight:bold;">üé® Farb-Z√§hler (wie oft eine Farbe angeklickt wurde):</div>
  <div id="counter-gelb">Gelb gewechselt: 0√ó</div>
  <div id="counter-gruen">Gr√ºn gewechselt: 0√ó</div>
  <div id="counter-lila">Lila gewechselt: 0√ó</div>
  <div id="counter-schwarz">Schwarz gewechselt: 0√ó</div>
</div>
</details>

<div class="row">

  <div class="half">
    <label for="drucker">Drucker w√§hlen:</label>
    <select id="drucker">
      <option value="T2-C Drucker 1">T2-C Drucker 1</option>
      <option value="T2-C Drucker 2">T2-C Drucker 2</option>
    </select>
  </div>
  <div class="half">
    <label for="personal">Personal:</label>
    <select id="personal">
      <option value="Mitarbeiter A">Mitarbeiter A</option>
      <option value="Mitarbeiter B">Mitarbeiter B</option>
      <option value="Mitarbeiter C">Mitarbeiter C</option>
    </select>
  </div>
</div>

<label for="aktion">Was wurde gemacht?</label>
<select id="aktion">
  <option value="Farbwechsel">Farbwechsel</option>
  <option value="Wiper gewechselt">Wiper gewechselt</option>
  <option value="Druckkopf gewechselt">Druckkopf gewechselt</option>
</select>

<label for="seriennummer">Seriennummer:</label>
<input type="text" id="seriennummer" placeholder="z.‚ÄØB. T2C-123456" />

<label for="leistung">Leistung beim Wechsel (z.‚ÄØB. Auftr√§ge):</label>
<input type="text" id="leistung" placeholder="z.‚ÄØB. 120000 Etiketten" />

<label for="etiketten">Etikettenz√§hler (optional, nur Zahl f√ºr Auswertung):</label>
<input type="number" id="etiketten" placeholder="z.‚ÄØB. 120000" />
<div class="muted">Tipp: Wenn hier eine Zahl steht, kann die App ‚ÄûVerschlei√ü pro 100.000 Etiketten‚Äú berechnen.</div>


<label>Welche Farbe(n)?</label>
<div>
  <label><input type="checkbox" value="Gelb" class="farbe"> Gelb</label>
  <label><input type="checkbox" value="Gr√ºn" class="farbe"> Gr√ºn</label>
  <label><input type="checkbox" value="Lila" class="farbe"> Lila</label>
  <label><input type="checkbox" value="Schwarz" class="farbe"> Schwarz</label>
</div>
<div id="farbenHint" class="muted" style="margin-top:6px; display:none;">Farbauswahl ist nur bei Aktion ‚ÄûFarbwechsel‚Äú aktiv.</div>

<label for="fehler">Fehler (optional):</label>
<select id="fehler">
  <option value="">‚Äì Kein Fehler ‚Äì</option>
  <option value="Printhead Unprimed">Printhead Unprimed</option>
  <option value="Maintenance Jam">Maintenance Jam</option>
  <option value="NIP Open">NIP Open</option>
  <option value="Fehler NA">Fehler NA</option>
</select>

<label for="bemerkung">Bemerkung:</label>
<textarea id="bemerkung" rows="3" placeholder="Zus√§tzliche Hinweise oder Fehlerbeschreibung..."></textarea>

<div class="top-actions">
  <button class="btn" onclick="saveEntry()">‚ûï Eintrag speichern (Cloud)</button>
  <button class="btn secondary" onclick="alsPDFExportieren()">üìÑ Exportieren als PDF</button>
</div>

<div class="search-box">
  <label for="suchfeld">üîç Suchen (z.‚ÄØB. nach Drucker oder Farbe):</label>
  <input type="text" id="suchfeld" onkeyup="sucheInTabelle()" placeholder="Suchbegriff eingeben..." />
</div>

<table class="log-table" id="wartungsliste">
  <thead>
    <tr>
      <th>Datum</th>
      <th>Uhrzeit</th>
      <th>Drucker</th>
      <th>Aktion</th>
      <th>Seriennummer</th>
      <th>Farben</th>
      <th>Leistung</th>
      <th>Fehler</th>
      <th>Personal</th>
      <th>Bemerkung</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<details class="dash-details" id="colorStatsDetails">
  <summary>üìà Farbwechsel-Statistik anzeigen/ausblenden</summary>
  <div class="chart-box">
    <h3>üìà Farbwechsel-Statistik</h3>
    <canvas id="colorChart" width="600" height="300"></canvas>
  </div>
</details>


<script>
/* Ensure MSAL is available (fallback to Microsoft CDN if jsDelivr is blocked) */
(function(){
  function loadScript(src){
    return new Promise(function(resolve,reject){
      var s=document.createElement('script');
      s.src=src;
      s.onload=resolve;
      s.onerror=reject;
      document.head.appendChild(s);
    });
  }
  window.__ensureMsal = async function(){
    if (window.msal && window.msal.PublicClientApplication) return;
    try{
      // Fallback (Microsoft official CDN). Version path is stable for v2; works for our use too.
      await loadScript("https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js");
    }catch(e){
      console.error("Failed to load MSAL from fallback CDN", e);
    }
  };
})();
</script>

<script>
// =============================
// 0) APP SETTINGS (Azure + Ordner)
// =============================
const APP_SETTINGS = {
  clientId: "a797d95e-04be-4549-a8c6-d137da4b10ab",
  tenantId: "f54f53bb-d0ff-4b78-bcf4-4aeeeb924428",
  redirectUri: "https://thiemann423.github.io/t2c-wartung",
  // Ordner-Link (Sharing-Link) ‚Äì wird √ºber /shares/{shareId}/driveItem aufgel√∂st:
  folderShareUrl: "https://petrifeinkost-my.sharepoint.com/my?id=%2Fpersonal%2Fmerten%5Fthiemann%5Fpetri%2Dfeinkost%5Fde%2FDocuments%2FT2CD%5FDrucker&viewid=01466968%2D95c1%2D4d89%2D8bc7%2D8fb257b34162",
  // Name der Logdatei im Ordner:
  logFileName: "t2c-wartung-log.json",
  // Minimale Scopes (Delegated) f√ºr Graph:
  scopes: ["User.Read", "Files.ReadWrite.All"]
};

// =============================
// 1) MSAL AUTH
// =============================
const msalConfig = {
  auth: {
    clientId: APP_SETTINGS.clientId,
    authority: `https://login.microsoftonline.com/${APP_SETTINGS.tenantId}`,
    redirectUri: APP_SETTINGS.redirectUri
  },
  cache: {
    cacheLocation: "localStorage",
    storeAuthStateInCookie: false
  }
};

let msalInstance = null;

async function initMsal(){
  if (window.__ensureMsal) { await window.__ensureMsal(); }
  if (!window.msal || !window.msal.PublicClientApplication) {
    throw new Error("MSAL library not loaded (msal undefined).");
  }
  if (!msalInstance) {
    msalInstance = new msal.PublicClientApplication(msalConfig);
    if (typeof msalInstance.initialize === "function") {
      await initMsal();
    }
  }
  return msalInstance;
}


let activeAccount = null;

function setStatus(kind, text) {
  const el = document.getElementById("authStatus");
  el.classList.remove("ok", "warn", "err");
  el.classList.add(kind);
  el.textContent = text;
}

async function signIn() {
  try {
    await initMsal();
    const result = await msalInstance.loginPopup({ scopes: APP_SETTINGS.scopes });
    activeAccount = result.account;
    msalInstance.setActiveAccount(activeAccount);
    setStatus("ok", `Angemeldet als: ${activeAccount.username}`);
    await ensureCloudReady();
    await loadFromCloud();
  } catch (e) {
    console.error(e);
    setStatus("err", "Anmeldung fehlgeschlagen. Details in der Konsole.");
  }
}

async function signOut() {
  try {
    await initMsal();
    const account = msalInstance.getActiveAccount();
    if (!account) {
      setStatus("warn", "Nicht angemeldet.");
      return;
    }
    await msalInstance.logoutPopup({ account });
    activeAccount = null;
    setStatus("warn", "Abgemeldet.");
    document.getElementById("cloudLocation").textContent = "(wird nach Anmeldung aufgel√∂st)";
  } catch (e) {
    console.error(e);
    setStatus("err", "Abmeldung fehlgeschlagen. Details in der Konsole.");
  }
}

async function getAccessToken() {
  await initMsal();
  const account = msalInstance.getActiveAccount() || activeAccount;
  if (!account) throw new Error("Not signed in");
  const result = await msalInstance.acquireTokenSilent({ account, scopes: APP_SETTINGS.scopes });
  return result.accessToken;
}

// =============================
// 2) GRAPH HELPERS
// =============================
function toBase64Url(str) {
  // btoa works for ASCII; ensure URI encoded.
  return btoa(unescape(encodeURIComponent(str)))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
}

function createShareIdFromUrl(url) {
  // Graph shareId format: u!<base64url(shareUrl)>
  return "u!" + toBase64Url(url);
}

async function graphFetch(url, options = {}) {
  const token = await getAccessToken();
  const headers = options.headers || {};
  headers["Authorization"] = `Bearer ${token}`;
  headers["Content-Type"] = headers["Content-Type"] || "application/json";
  const resp = await fetch(url, { ...options, headers });
  if (!resp.ok) {
    const txt = await resp.text();
    throw new Error(`Graph error ${resp.status}: ${txt}`);
  }
  // Some endpoints return no content
  if (resp.status === 204) return null;
  const ct = resp.headers.get("content-type") || "";
  if (ct.includes("application/json")) return await resp.json();
  return await resp.text();
}

// =============================
// 3) CLOUD STORAGE: Resolve folder + read/write JSON log
// =============================
let cloud = {
  driveId: null,
  folderId: null,
  folderName: null,
  fileItemId: null
};

async function resolveFolderFromShareUrl() {
  const shareId = createShareIdFromUrl(APP_SETTINGS.folderShareUrl);
  const driveItem = await graphFetch(`https://graph.microsoft.com/v1.0/shares/${shareId}/driveItem`);
  // driveItem is the item behind the sharing link (folder or file)
  const driveId = driveItem.parentReference?.driveId || driveItem.remoteItem?.parentReference?.driveId;
  const folderId = driveItem.id || driveItem.remoteItem?.id;
  const name = driveItem.name || driveItem.remoteItem?.name || "Ordner";
  if (!driveId || !folderId) throw new Error("Konnte driveId/folderId nicht aufl√∂sen.");
  cloud.driveId = driveId;
  cloud.folderId = folderId;
  cloud.folderName = name;
  document.getElementById("cloudLocation").textContent = `${name} (drive: ${driveId})`;
}

async function findOrCreateLogFile() {
  // Try to find existing file in folder
  const children = await graphFetch(`https://graph.microsoft.com/v1.0/drives/${cloud.driveId}/items/${cloud.folderId}/children?$select=id,name`);
  const existing = (children.value || []).find(x => x.name === APP_SETTINGS.logFileName);
  if (existing) {
    cloud.fileItemId = existing.id;
    return;
  }
  // Create empty JSON file
  const initial = {
    version: 1,
    createdAt: new Date().toISOString(),
    entries: []
  };
  const url = `https://graph.microsoft.com/v1.0/drives/${cloud.driveId}/items/${cloud.folderId}:/${encodeURIComponent(APP_SETTINGS.logFileName)}:/content`;
  const token = await getAccessToken();
  const resp = await fetch(url, {
    method: "PUT",
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(initial, null, 2)
  });
  if (!resp.ok) {
    const txt = await resp.text();
    throw new Error(`Konnte Logdatei nicht erstellen (${resp.status}): ${txt}`);
  }
  const created = await resp.json();
  cloud.fileItemId = created.id;
}

async function readLog() {
  if (!cloud.fileItemId) await findOrCreateLogFile();
  const url = `https://graph.microsoft.com/v1.0/drives/${cloud.driveId}/items/${cloud.fileItemId}/content`;
  const token = await getAccessToken();
  const resp = await fetch(url, {
    headers: { "Authorization": `Bearer ${token}` }
  });
  if (!resp.ok) {
    const txt = await resp.text();
    throw new Error(`Konnte Log nicht lesen (${resp.status}): ${txt}`);
  }
  const text = await resp.text();
  try {
    return JSON.parse(text);
  } catch {
    // If file exists but is empty/corrupt
    return { version: 1, createdAt: new Date().toISOString(), entries: [] };
  }
}

async function writeLog(logObj) {
  if (!cloud.fileItemId) await findOrCreateLogFile();
  const url = `https://graph.microsoft.com/v1.0/drives/${cloud.driveId}/items/${cloud.fileItemId}/content`;
  const token = await getAccessToken();
  const resp = await fetch(url, {
    method: "PUT",
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(logObj, null, 2)
  });
  if (!resp.ok) {
    const txt = await resp.text();
    throw new Error(`Konnte Log nicht schreiben (${resp.status}): ${txt}`);
  }
  return await resp.json(); // returns driveItem
}

async function ensureCloudReady() {
  const account = msalInstance.getActiveAccount();
  if (!account) {
    setStatus("warn", "Nicht angemeldet.");
    throw new Error("Not signed in");
  }
  if (!cloud.driveId || !cloud.folderId) {
    await resolveFolderFromShareUrl();
  }
  if (!cloud.fileItemId) {
    await findOrCreateLogFile();
  }
}

// =============================
// 4) UI + DATA MODEL
// =============================
let zaehler = { "Gelb": 0, "Gr√ºn": 0, "Lila": 0, "Schwarz": 0 };
let allEntries = []; // authoritative list from cloud

function resetTable() {
  const tbody = document.querySelector("#wartungsliste tbody");
  tbody.innerHTML = "";
}

function recomputeCounters(entries) {
  // Z√§hlt Farbwechsel NUR f√ºr Eintr√§ge mit Aktion "Farbwechsel"
  zaehler = { "Gelb": 0, "Gr√ºn": 0, "Lila": 0, "Schwarz": 0 };
  for (const e of entries) {
    const aktion = (e.aktion || "").trim();
    if (aktion !== "Farbwechsel") continue;
    const farben = (e.farben || "").split(",").map(s => s.trim()).filter(Boolean);
    for (const f of farben) if (zaehler[f] !== undefined) zaehler[f] += 1;
  }
  updateAdvancedDashboard(entries);
  updateDashboard();
  updateChart();
}

function renderEntries(entries) {
  resetTable();
  const tbody = document.querySelector("#wartungsliste tbody");
  for (const e of entries) {
    const tr = document.createElement("tr");
    const cells = [
      e.datum || "",
      e.zeit || "",
      e.drucker || "",
      e.aktion || "",
      e.seriennummer || "",
      e.farben || "",
      e.leistung || "",
      e.fehler || "",
      e.personal || "",
      e.bemerkung || ""
    ];
    cells.forEach(text => {
      const td = document.createElement("td");
      td.textContent = text;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
}

function updateDashboard() {
  document.getElementById("counter-gelb").textContent = `Gelb gewechselt: ${zaehler["Gelb"]}√ó`;
  document.getElementById("counter-gruen").textContent = `Gr√ºn gewechselt: ${zaehler["Gr√ºn"]}√ó`;
  document.getElementById("counter-lila").textContent = `Lila gewechselt: ${zaehler["Lila"]}√ó`;
  document.getElementById("counter-schwarz").textContent = `Schwarz gewechselt: ${zaehler["Schwarz"]}√ó`;
}

async function loadFromCloud() {
  try {
    await initMsal();
    await ensureCloudReady();
    setStatus("ok", `Angemeldet als: ${(msalInstance.getActiveAccount()||{}).username} ‚Äì lade Daten...`);
    const log = await readLog();
    allEntries = Array.isArray(log.entries) ? log.entries : [];
    renderEntries(allEntries);
    recomputeCounters(allEntries);
    setStatus("ok", `Daten geladen: ${allEntries.length} Eintr√§ge.`);
  } catch (e) {
    console.error(e);
    setStatus("err", "Laden fehlgeschlagen (siehe Konsole).");
  }
}

function collectEntryFromForm() {
  const jetzt = new Date();
  const datum = jetzt.toLocaleDateString();
  const zeit = jetzt.toLocaleTimeString();
  const drucker = document.getElementById("drucker").value;
  const personal = document.getElementById("personal").value;
  const seriennummer = document.getElementById("seriennummer").value;
  const aktion = document.getElementById("aktion").value;
  const leistung = document.getElementById("leistung").value;
  const etikettenRaw = (document.getElementById("etiketten")||{value:""}).value;
  const fehler = document.getElementById("fehler").value;
  const bemerkung = document.getElementById("bemerkung").value;
  const farbenListe = [...document.querySelectorAll(".farbe:checked")].map(cb => cb.value);
  const farben = farbenListe.join(", ");

  const etikettenCount = parseEtikettenCount(etikettenRaw || leistung);

  return {
    datum, zeit, drucker, aktion, seriennummer, farben, leistung, fehler, personal, bemerkung,
    etikettenCount,
    // machine fields:
    createdAt: new Date().toISOString()
  };
}

let __colorsEnabledPrev = null;

function updateColorCheckboxEnabled() {
  const aktion = document.getElementById("aktion")?.value || "";
  const enable = (aktion === "Farbwechsel");
  // If the user just switched to "Farbwechsel", jump focus to the first color checkbox
  if (enable && __colorsEnabledPrev === false) {
    setTimeout(() => {
      const first = document.querySelector('.farbe:not([disabled])');
      if (first) first.focus();
    }, 0);
  }
  __colorsEnabledPrev = enable;
  document.querySelectorAll(".farbe").forEach(cb => {
    cb.disabled = !enable;
    if (!enable) cb.checked = false;
  });
  const hint = document.getElementById("farbenHint");
  if (hint) {
    hint.style.display = enable ? "none" : "block";
  }
}

function resetForm() {
  document.getElementById("seriennummer").value = "";
  document.getElementById("leistung").value = "";
  document.getElementById("bemerkung").value = "";
  const et = document.getElementById("etiketten"); if (et) et.value = "";
  document.querySelectorAll(".farbe").forEach(cb => cb.checked = false);
  document.getElementById("fehler").value = "";
}

async function saveEntry() {
  try {
    await ensureCloudReady();

    // Simple validation
    const entry = collectEntryFromForm();
    if (!entry.drucker || !entry.personal || !entry.aktion) {
      alert("Bitte Drucker, Personal und Aktion ausw√§hlen.");
      return;
    }

    setStatus("ok", "Speichere Eintrag in Cloud...");

    // Read latest, append, write back (simple approach)
    const log = await readLog();
    const entries = Array.isArray(log.entries) ? log.entries : [];
    entries.push(entry);
    log.entries = entries;

    await writeLog(log);

    // Refresh UI
    allEntries = entries;
    renderEntries(allEntries);
    recomputeCounters(allEntries);

    resetForm();
    setStatus("ok", `Gespeichert. Gesamt: ${allEntries.length} Eintr√§ge.`);
  } catch (e) {
    console.error(e);
    setStatus("err", "Speichern fehlgeschlagen (siehe Konsole).");
    alert("Speichern fehlgeschlagen. Bitte Konsole √∂ffnen (F12) und Meldung pr√ºfen.");
  }
}

// Suche (clientseitig)
function sucheInTabelle() {
  const input = document.getElementById("suchfeld").value.toLowerCase();
  const rows = document.querySelectorAll("#wartungsliste tbody tr");
  rows.forEach(row => {
    const match = [...row.children].some(cell => cell.textContent.toLowerCase().includes(input));
    row.style.display = match ? "" : "none";
  });
}

// PDF-Export
function alsPDFExportieren() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("T2-C Wartungsprotokoll", 14, 15);

  const rows = [];
  document.querySelectorAll("#wartungsliste tbody tr").forEach(row => {
    const rowData = [];
    row.querySelectorAll("td").forEach(cell => rowData.push(cell.textContent));
    rows.push(rowData);
  });

  doc.autoTable({
    head: [["Datum", "Uhrzeit", "Drucker", "Aktion", "Seriennummer", "Farben", "Leistung", "Fehler", "Personal", "Bemerkung"]],
    body: rows,
    startY: 25
  });
  doc.save("T2C_Wartung.pdf");
}


// =============================
// 4b) ADVANCED DASHBOARD (Verschlei√ü / Ger√§t / Zeit)
// =============================
let printerChartObj = null;
let actionChartObj = null;
let colorPerPrinterChartObj = null;
let monthlyChartObj = null;

let __colorByPrinter = null;
let __printersList = null;

function safeDestroy(chartObj){
  try{ if(chartObj) chartObj.destroy(); }catch(e){}
}

function ensurePrinterFilterOptions(printers){
  const sel = document.getElementById("dashPrinterFilter");
  if (!sel) return;
  const current = sel.value || "__ALL__";

  // rebuild
  sel.innerHTML = '<option value="__ALL__">Alle Drucker</option>';
  for (const p of printers){
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    sel.appendChild(opt);
  }

  // restore if possible
  const exists = [...sel.options].some(o => o.value === current);
  sel.value = exists ? current : "__ALL__";
}

function updateColorPerPrinterChart(){
  const canvas = document.getElementById("colorPerPrinterChart");
  const sel = document.getElementById("dashPrinterFilter");
  if (!canvas || !sel || !__colorByPrinter || !__printersList) return;

  const pick = sel.value || "__ALL__";
  const colors = ["Gelb","Gr√ºn","Lila","Schwarz"];

  // aggregate for selection
  const counts = {Gelb:0, "Gr√ºn":0, Lila:0, Schwarz:0};
  if (pick === "__ALL__"){
    for (const p of __printersList){
      const pc = __colorByPrinter[p] || {};
      for (const c of colors) counts[c] += (pc[c] || 0);
    }
  } else {
    const pc = __colorByPrinter[pick] || {};
    for (const c of colors) counts[c] = (pc[c] || 0);
  }

  const ctx = canvas.getContext("2d");
  safeDestroy(colorPerPrinterChartObj);
  colorPerPrinterChartObj = new Chart(ctx, {
    type: "bar",
    data: {
      labels: colors,
      datasets: [{
        label: (pick === "__ALL__") ? "Alle Drucker" : pick,
        data: colors.map(c => counts[c])
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });
}

function parseMonthLabel(entry){
  // Prefer machine time, fallback to displayed date
  const iso = entry.createdAt;
  if (iso) {
    const d = new Date(iso);
    if (!isNaN(d.getTime())) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${m}`;
    }
  }
  // Fallback: try dd.mm.yyyy
  const s = entry.datum || "";
  const m = s.match(/(\d{1,2})\.(\d{1,2})\.(\d{4})/);
  if (m){
    const y = m[3];
    const mm = String(m[2]).padStart(2,"0");
    return `${y}-${mm}`;
  }
  return "Unbekannt";
}

function updateAdvancedDashboard(entries){
  const total = entries.length;

  // Counts by action
  const byAction = {};
  const byPrinter = {};
  const byMonth = {};

  // Farben pro Drucker (f√ºr Verbrauch/Fehlerbilder)
  const colors = ["Gelb","Gr√ºn","Lila","Schwarz"];
  const colorByPrinter = {}; // colorByPrinter[printer][color] = count

  let lastIso = null;

  for(const e of entries){
    const a = (e.aktion || "Unbekannt").trim();
    const p = (e.drucker || "Unbekannt").trim();
    byAction[a] = (byAction[a] || 0) + 1;
    byPrinter[p] = (byPrinter[p] || 0) + 1;

    const month = parseMonthLabel(e);
    byMonth[month] = (byMonth[month] || 0) + 1;

    // colors (NUR bei Aktion "Farbwechsel")
    if (a === "Farbwechsel") {
      if (!colorByPrinter[p]) colorByPrinter[p] = {Gelb:0,"Gr√ºn":0,Lila:0,Schwarz:0};
      const fs = (e.farben || "").split(",").map(s => s.trim()).filter(Boolean);
    for (const f of fs){
      if (colorByPrinter[p][f] !== undefined) colorByPrinter[p][f] += 1;
    }
    }

    if (e.createdAt){
      if (!lastIso || e.createdAt > lastIso) lastIso = e.createdAt;
    }
  }

  // KPIs
  document.getElementById("kpi-total").textContent = total;
  document.getElementById("kpi-printhead").textContent = byAction["Druckkopf gewechselt"] || 0;
  document.getElementById("kpi-wiper").textContent = byAction["Wiper gewechselt"] || 0;
  document.getElementById("kpi-colorchange").textContent = byAction["Farbwechsel"] || 0;

  const lastText = lastIso ? new Date(lastIso).toLocaleString() : "‚Äì";
  document.getElementById("kpi-last").textContent = `Letzter Eintrag: ${lastText}`;

  // Charts
  // 1) Wartungen pro Ger√§t
  const printerLabels = Object.keys(byPrinter);
  const printerData = printerLabels.map(k => byPrinter[k]);

  // Store + build filter for "Farben pro Drucker"
  __colorByPrinter = colorByPrinter;
  __printersList = printerLabels.slice().sort((a,b)=>a.localeCompare(b,"de"));
  ensurePrinterFilterOptions(__printersList);

  const pctx = document.getElementById("printerChart").getContext("2d");
  safeDestroy(printerChartObj);
  printerChartObj = new Chart(pctx, {
    type: "bar",
    data: { labels: printerLabels, datasets: [{ label: "Wartungen", data: printerData }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
  });

  // 2) Wartungen nach Art
  const actionLabels = Object.keys(byAction);
  const actionData = actionLabels.map(k => byAction[k]);

  const actx = document.getElementById("actionChart").getContext("2d");
  safeDestroy(actionChartObj);
  actionChartObj = new Chart(actx, {
    type: "bar",
    data: { labels: actionLabels, datasets: [{ label: "Anzahl", data: actionData }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
  });


  updateColorPerPrinterChart();

  // 3) Wartungen pro Monat (sortiert)
  const monthLabels = Object.keys(byMonth).sort();
  const monthData = monthLabels.map(k => byMonth[k]);

  const mctx = document.getElementById("monthlyChart").getContext("2d");
  safeDestroy(monthlyChartObj);
  monthlyChartObj = new Chart(mctx, {
    type: "line",
    data: { labels: monthLabels, datasets: [{ label: "Wartungen/Monat", data: monthData, tension: 0.2 }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
  });

  renderWearMatrix(entries);
  renderWearPer100k(entries);
}

function renderWearMatrix(entries){
  const table = document.getElementById("wearMatrix");
  if (!table) return;

  const actions = ["Farbwechsel", "Wiper gewechselt", "Druckkopf gewechselt"];
  const printersSet = new Set(entries.map(e => (e.drucker || "Unbekannt").trim()));
  const printers = Array.from(printersSet).sort((a,b)=>a.localeCompare(b, "de"));

  // Build counts
  const counts = {}; // counts[printer][action] = n
  for (const p of printers) counts[p] = {};
  for (const e of entries){
    const p = (e.drucker || "Unbekannt").trim();
    const a = (e.aktion || "Unbekannt").trim();
    if (!counts[p]) counts[p] = {};
    counts[p][a] = (counts[p][a] || 0) + 1;
  }

  // Header
  let html = "<thead><tr><th>Drucker</th>";
  for (const a of actions) html += `<th>${a}</th>`;
  html += "<th>Summe</th></tr></thead><tbody>";

  // Rows
  const colTotals = Object.fromEntries(actions.map(a=>[a,0]));
  let grandTotal = 0;

  for (const p of printers){
    let rowSum = 0;
    html += `<tr><td class="left">${p}</td>`;
    for (const a of actions){
      const v = counts[p][a] || 0;
      rowSum += v;
      colTotals[a] += v;
      html += `<td>${v}</td>`;
    }
    grandTotal += rowSum;
    html += `<td><b>${rowSum}</b></td></tr>`;
  }

  // Totals row
  html += `<tr><td class="left"><b>Summe</b></td>`;
  for (const a of actions){
    html += `<td><b>${colTotals[a]}</b></td>`;
  }
  html += `<td><b>${grandTotal}</b></td></tr>`;
  html += "</tbody>";

  table.innerHTML = html;
}

function parseEtikettenCount(value){
  if (value === null || value === undefined) return null;
  let s = String(value).trim();
  if (!s) return null;

  // normalize
  s = s.toLowerCase().replace(/etiketten|labels|st\.|stk\.|st√ºcke|pcs/gi, " ").trim();

  // Match: number with separators + optional k/m suffix
  const m = s.match(/(\d[\d\s\.,]*)(?:\s*([km]))?/i);
  if (!m) return null;

  let num = m[1].replace(/\s+/g, "");
  // remove thousands separators
  num = num.replace(/\./g, "").replace(/,/g, "");
  if (!/^\d+$/.test(num)) return null;

  let n = parseInt(num, 10);
  const suf = (m[2] || "").toLowerCase();
  if (suf === "k") n = n * 1000;
  if (suf === "m") n = n * 1000000;

  if (!isFinite(n) || n <= 0) return null;
  return n;
}

function renderWearPer100k(entries){
  const table = document.getElementById("wearPer100k");
  if (!table) return;

  const actions = ["Farbwechsel", "Wiper gewechselt", "Druckkopf gewechselt"];
  const printersSet = new Set(entries.map(e => (e.drucker || "Unbekannt").trim()));
  const printers = Array.from(printersSet).sort((a,b)=>a.localeCompare(b, "de"));

  // Sum labels per printer + counts per action
  const labelsByPrinter = {};
  const counts = {}; // counts[printer][action]
  for (const p of printers){ labelsByPrinter[p] = 0; counts[p] = {}; }

  for (const e of entries){
    const p = (e.drucker || "Unbekannt").trim();
    const a = (e.aktion || "Unbekannt").trim();
    if (!counts[p]) counts[p] = {};
    counts[p][a] = (counts[p][a] || 0) + 1;

    const lbl = (typeof e.etikettenCount === "number" && e.etikettenCount > 0) ? e.etikettenCount : parseEtikettenCount(e.leistung);
    if (lbl && isFinite(lbl)) labelsByPrinter[p] = (labelsByPrinter[p] || 0) + lbl;
  }

  // Header
  let html = "<thead><tr><th>Drucker</th><th>Etiketten ges.</th>";
  for (const a of actions) html += `<th>${a} /100k</th>`;
  html += "<th>Wartungen ges. /100k</th></tr></thead><tbody>";

  for (const p of printers){
    const totalLabels = labelsByPrinter[p] || 0;
    const denom = totalLabels / 100000;
    html += `<tr><td class="left">${p}</td><td>${totalLabels ? totalLabels.toLocaleString("de-DE") : "‚Äî"}</td>`;

    let totalMaint = 0;
    for (const a of actions) totalMaint += (counts[p][a] || 0);

    for (const a of actions){
      const c = counts[p][a] || 0;
      const rate = (denom > 0) ? (c / denom) : null;
      html += `<td>${rate === null ? "‚Äî" : rate.toFixed(2)}</td>`;
    }

    const totalRate = (denom > 0) ? (totalMaint / denom) : null;
    html += `<td><b>${totalRate === null ? "‚Äî" : totalRate.toFixed(2)}</b></td></tr>`;
  }

  html += "</tbody>";
  table.innerHTML = html;
}



// Chart
let chart;
function updateChart() {
  const ctx = document.getElementById("colorChart").getContext("2d");
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["Gelb", "Gr√ºn", "Lila", "Schwarz"],
      datasets: [{
        label: "Anzahl Farbwechsel",
        data: [zaehler["Gelb"], zaehler["Gr√ºn"], zaehler["Lila"], zaehler["Schwarz"]],
        backgroundColor: ["#FFD700", "#66CC66", "#CC66CC", "#333"]
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      }
    }
  });
}

// Auto-detect existing session
(async function boot() {
  try {
    // UX: Farben nur bei Aktion ‚ÄûFarbwechsel‚Äú
    const aktionEl = document.getElementById("aktion");
    if (aktionEl) aktionEl.addEventListener("change", updateColorCheckboxEnabled);
    updateColorCheckboxEnabled();
    await initMsal();
    const accounts = msalInstance.getAllAccounts();
    if (accounts.length > 0) {
      activeAccount = accounts[0];
      msalInstance.setActiveAccount(activeAccount);
      setStatus("ok", `Angemeldet als: ${activeAccount.username}`);
      await ensureCloudReady();
      await loadFromCloud();
    } else {
      setStatus("warn", "Nicht angemeldet. Bitte oben auf ‚ÄûAnmelden‚Äú klicken.");
    }
  } catch (e) {
    console.error(e);
    setStatus("err", "Initialisierung fehlgeschlagen (siehe Konsole).");
  }
})();
</script>

</body>
</html>
